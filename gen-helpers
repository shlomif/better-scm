#!/usr/bin/env perl

use strict;
use warnings;

use HTML::Latemp::GenMakeHelpers;

sub _exec
{
    my ( $cmd, $err ) = @_;

    if ( system(@$cmd) )
    {
        die $err;
    }
    return;
}

_exec(
    [
        'cookiecutter', '-f', '--no-input',
        'gh:shlomif/cookiecutter--shlomif-latemp-sites',
        'project_slug=.',
    ],
    'cookiecutter failed.'
);

if ( system( "make", "--silent", "-f", "lib/make/build-deps/build-deps.mak" ) )
{
    die "build-deps failed!";
}

my $DIR = "lib/make/";

my $generator = HTML::Latemp::GenMakeHelpers->new(
    'hosts' => [
        {
            'id'         => "common",
            'source_dir' => "common",
            'dest_dir'   => "\$(D)",
        },
        {
            'id'         => "berlios",
            'source_dir' => "src",
            'dest_dir'   => "\$(D)",
        },
    ],
    out_dir => $DIR,
);

$generator->process_all();

open my $out_fh, ">", "Makefile" or die "Cannot open Makefile $!";
print {$out_fh} "include $DIR/main.mak\n";
close($out_fh);
